---
title: 站点缓存 API 文档
---
# SSR 缓存实现说明

## 概述

本项目已实现基于 Redis 的 SSR HTML 缓存系统，实现以下功能：

- 首次访问进行服务端渲染并缓存 HTML X 小时
- 后续访问直接返回缓存的 HTML，提升响应速度
- 客户端自动刷新数据，确保内容新鲜度
- 提供缓存管理接口

## 配置说明

### 环境变量

在 `.env` 文件中添加以下配置：

```bash
# SSR 缓存管理员令牌（用于缓存清理接口）
SSR_CACHE_ADMIN_TOKEN=your-secure-admin-token // 暂未使用，考虑做成动态验证
```

### 缓存配置

在 `nuxt.config.ts` 中的配置：

```typescript
runtimeConfig: {
  // 服务端配置
  ssrCache: {
    enabled: true,
    ttl: 14400, // 4小时 未使用
    exclude: ['^/auth', '^/merchants', '^/register-h5', '^/cart', '^/cashier', '^/debug'],
    adminToken: process.env.SSR_CACHE_ADMIN_TOKEN || 'default-admin-token'
  },
  // 公共配置
  public: {
    ssrCache: {
      enabled: true,
      ttl: 14400 // 未使用
    }
  }
}
```

## 缓存规则

### 包含的路由

以下路由会被缓存：

```ts
// 路径模式到TTL的映射（单位：秒）
// 匹配规则：按精确度选择最长匹配（更精确的模式优先）
// 缓存页面需要增加 data-cache="cache-correct-control" 接口请求成功后再缓存
export const CACHE_TTL_MAP: Record<string, number> = {
  '/': 28800,                    // 首页：8小时
  '/goods-detail/**': 3600 * 4,      // 商品详情：4小时
  '/market/**': 3600 * 24,           // 市场：24小时
  '/mall/**': 3600 * 4,             // 商城：4小时
  '/national-pavilion/**': 3600 * 24, // 国家馆：12小时
  '/outside-trade-serve/**': 3600 * 24, // 外贸服务：12小时
  '/ai-tools/**': 3600 * 24 * 7, // AI工具：7天
  '/shop/**': 3600 * 24, // 店铺：24小时
  '/government-services/**': 3600 * 24, // 政府服务：24小时
  '/service-market/**': 3600 * 24 * 7, // 服务市场：7天
  '/about-us/**': 3600 * 24 * 7, // 关于我们：7天
}
```

### 排除的路由

以下路由不会被缓存：

```ts
export const CACHE_EXCLUDE_PATTERNS = [
  '^/auth',
  '^/merchants',
  '^/register-h5',
  '^/cart',
  '^/cashier',
  '^/debug',
  '^/mall/search-goods_0'
]
```

## 缓存键规则

缓存键格式：`GET:站点:AB目录:租户:(站点/API)_文件名`

:::prose-note
示例：
- `1:T0001:cn_page__`
- `1:T0001:mall_category_123`
:::

## API 接口

### 统一缓存控制（`GET /api/cache`）

`/api/cache` 提供所有缓存操作，通过 `action` 区分具体能力。默认基于当前请求解析租户 ID（也可显式传 `tenantId`），并结合 `nationalType` 拼装缓存键。

| 查询参数 | 必填 | 说明 |
| --- | --- | --- |
| `action` | 是 | 操作类型，见下表 |
| `key` | 否 | 某些操作需要：<br>- 对数据源缓存：`payPriceType`、`priceType`、`marketSeo`、`seoTree`、`firstTitleTdk`<br>- 对 FS 缓存：为要清理的 URL |
| `referer` | 否 | 透传给数据源，覆盖自动识别的 Referer |
| `tenantId` | 否 | 管理租户缓存时指定目标租户，默认当前 |

> 管理操作需要携带 `x-cache-admin-token`，令牌来自 `runtimeConfig.ssrCache.adminToken`（TOKEN可以考虑做动态验证）。

#### 操作与示例

所有示例可直接复制，将 `BASE_URL`、`TENANT_ID`、`ADMIN_TOKEN`、`URL_PATH` 等占位符替换成真实值即可。

##### 1. 拉取（并自动回源）数据源缓存 `action=get`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=get&key=marketSeo" \
  -H "Accept: application/json"
```

##### 2. 删除单个数据源缓存 `action=clear`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear&key=seoTree" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 3. 查看 Redis 缓存统计 `action=stats`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=stats&tenantId=TENANT_ID" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 4. 查看 API LRU 状态 `action=lru-stats`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=lru-stats&tenantId=TENANT_ID" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 5. 查看页面（FS）LRU 状态 `action=fs-lru-stats`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=fs-lru-stats&tenantId=TENANT_ID" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 6. 强制回源刷新数据源缓存 `action=refresh`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=refresh&key=payPriceType" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 7. 清除当前租户所有缓存（Redis + FS + LRU）`action=clear-all`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear-all" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 8. 清除当前租户所有页面缓存 `action=clear-fs-all`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear-fs-all" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 9. 清除单个页面缓存 `action=clear-fs`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear-fs&key=/goods-detail/123" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 10. 清除指定租户缓存 `action=clear-tenant`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear-tenant&tenantId=TENANT_ID" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 11. 清除所有租户缓存 `action=clear-all-tenants`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=clear-all-tenants" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 12. 查看指定租户缓存统计 `action=tenant-stats`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=tenant-stats&tenantId=TENANT_ID" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```

##### 13. 列出所有租户 `action=all-tenants-list`
```bash [Terminal]
curl -X GET "$BASE_URL/api/cache?action=all-tenants-list" \
  -H "x-cache-admin-token: $ADMIN_TOKEN"
```


## 客户端再验证

客户端会在以下时机自动刷新数据：

1. 应用挂载后
2. 路由切换后
3. 页面包含标识 `data-cache="cache-correct-control"`

刷新机制：
- 使用 `refreshNuxtData()` 刷新当前页面数据
- 100ms 节流，避免频繁刷新
- 可通过页面 meta 禁用：`definePageMeta({ noClientRefresh: true })`

## 监控和调试

### 响应头

每个响应都会包含以下头信息：

- `x-ssr-cache: hit|miss` - 缓存命中状态
- `x-cache-key: ${key}` - 缓存键

### 日志

SLS会输出缓存相关日志：

```
[Redis_Cache]
[API_Node_Cache_Get]
```

## 更新日志

- 2025-11-25: 租户修改
  - 租户维度获取接口数据

- 2025-10-20: 初始实现
  - 缓存管理接口
