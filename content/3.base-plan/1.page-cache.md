# 大集商城Nuxt缓存方案

# 方案

1.  Nitro的内置存储（基于文件）
    
2.  Redis（需要Redis服务器，在高流量下性能更优）
    
3.  内存（最快，但受服务器内存限制）
    

## 缓存策略

*   缓存时间：4小时
    
*   强制刷新：提供API，以便在内容更新时手动清除缓存
    
*   Redis存多久过期
    
*   本地文件存多久过期
    

## 缓存范围 - 哪些页面需要缓存？

*   仅限公共/静态页面（主页、市场、产品列表、新闻）
    
*   手动选择：仅选择您指定的高流量页面（首页1.2mb，市场页共136个，每个320k，共42.5MB、类目页共500个，每个690k，共336MB、其它一级菜单6个，70k，共4.2mb，全部缓存共384MB）
    
*   语言：忽略，不缓存当前站点的其它语言
    

页面：

*   `/` - 首页 走Redis缓存（舍弃HTML走Redis的方案，因Hash不同每次部署还是需要重新打包）
    
*   `/market/**` - 市场相关页面 走Redis缓存
    
*   `/mall/**` - 商城一级页 走Redis缓存
    
*   `^/mall/.+_page\d+$` 以\_page+数字结尾的路由  文件缓存
    
*   `/national-pavilion/**` - 国家馆页面 走Redis缓存
    
*   `/outside-trade-serve/**` - 外贸服务页面 走Redis缓存
    
*   `/about-us/**` - 关于我们页面 走Redis缓存
    
*   `/ai-tools/**` - AI 工具页面 走Redis缓存
    
*   `/shop/**` - 店铺页面  文件缓存
    
*   `/goods-detail/**` - 商品详情页面  文件缓存
    
*   `/government-services/**` - 政府服务页面 走Redis缓存
    
*   `/club/**` - 俱乐部页面 文件缓存
    

1.  api请求中增加一项 是否缓存到Redis，防止公共的多次请求
    
2.  是/goods-detail/\*\*缓存走文件缓存，其它自定义的路径比如/，/market/\*走Redis缓存
    

## 缓存存储 - 缓存应存储在何处？

*   Nitro的内置存储（重启后数据重置（非持久化）
    
*   ++Redis（需要Redis服务器，在高流量下性能更优，多实例可共享）++
    
*   内存（最快，但受服务器内存限制，重启后数据重置）
    

## 客户端刷新策略

*   每次访问页面时自动刷新数据（在初始缓存HTML加载后获取最新数据）
    

### 初次请求耗时

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/3cc013a9-92ed-42fa-8c5f-85117d4d618a.png)

### 命中缓存

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/f2da9698-7997-4205-91f5-0f4807ccb26e.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/5a05c27e-de28-4e63-b28e-9a6309fd3cd6.png)![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/5d845e72-c55e-47fa-a632-08621a4bb2d3.png)

# 服务器承载容量估算

生产环境：148272  上架商品

生产环境：340293  商品总数

服务器实例：硬盘容量为120G、内存容量为4G

| 数据项 | 数值 | 承载数 |
| --- | --- | --- |
| 单个列表页大小 | 大约700kb x 商品总数 | 6800页≈ 4.54GB |
| 单个详情页大小 | 大概200kb x 商品总数 ÷ 每页商品数 | 340000个≈ 64.8GB |
| 其它页面 | 未知kb x 100个活动页和一级页面 | ≈100MB |
| 总计 |  | ≈70GB ~ 100GB |

# 待办

*   [x] Nuxt文件缓存提供接口清除，定时清除
    
*   [ ] Nuxt文件缓存过期不会自动清理，是否需要设置缓存上限1000条
    
*   [x] Redis的HTML缓存冲突：重启，本地测试都会存在
    
*   [x] 若页面错误也会被缓存，通过增加缓存判断来确定是否需要缓存
    
*   [ ] 非SSR页面会刷新两次接口的问题
    
*   [x] 修改缓存逻辑，确保API请求失败时不缓存响应数据，避免缓存污染
    
*   [x] 热搜词未展示
    
*   [x] 根据页面配置差异化缓存时间
    
*   [x] curl请求已缓存页面也会导致接口请求的问题
    
*   [x] 详情部分组件刷新接口后内容未更新
    
*   [x] 类目，缓存后刷新页面币种无变化
    
*   [x] 类目页的TDK错误
    
*   [x] 英文站缓存击中的是主站
    

# 项目部署的缓存冲突

问题现象：

1.  一份缓存对应两个实例：项目部署时，删除旧实例P1缓存，存入新实例P2缓存，此时P1还可以访问，进入页面后命中P2的缓存，导致客户端加载资源404（共享NAS盘）
    
2.  多实例启动AB缓存判断：每次启动会自动切换AB目录，多实例下不可用
    
3.  部署实例删除缓存导致404：方案一：流水线删除 方案二：项目启动删除 方案三：旧容器退出时删除
    
4.  重启清缓存：k8s重启时，会切换缓存文件夹导致缓存被删除，实际代码是一样的无需清除缓存
    
5.  十分钟内部署的限制：会导致缓存目录不切换，缓存错位，新实例404，未达到十分钟的时候再次部署旧缓存未删除导致新启动目录404
    
6.  共享缓存：保证一个服务缓存了 其他服务共用
    

解决方案：

1.  AB双份缓存：P1旧容器访问A文件夹，P2新容器访问B文件夹
    
2.  十分钟计数：在缓存项目下记录第一次运行的时间，十分钟内不再切换AB目录
    
3.  其他方案会使旧缓存无效导致旧实例404，最终方案是：新容器启动十分钟后删除旧容器缓存
    
4.  获取打包后的id比对，若相同则不清除缓存，不切换缓存目录
    
5.  使用ID来判断是否需要切换缓存目录
    
6.  目录清理一次，开始启动清除当前要缓存的目录，延迟十分钟清理旧目录
    

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/7895ba84-6f11-4464-8024-25d815ad1a1c.png)

# 正式服第一次启动和重启

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/a85f1b0d-ff92-4f91-bea1-20fcd042296f.png)

# 部分缓存的接口

Node端接口：/api/init-data

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/46c8a2e2-e0a6-4059-9173-b59c2e2c9585.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/9fab6bb5-37e9-4aa7-9877-f44fe6b8eb82.png)

# 缓存怎么做

# nitro

# 写个接口示例

# Redis

## 1、 连接本地Redis开发

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/d7183f91-add8-49d0-ad71-4254f408ead1.png)

## 2、 打包后验证，如何连接本地Redis

找到打包后的Redis地址和密码 替换两处地方即可

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/Q35O851eXYEJAl9V/img/36d0b6b0-ca6f-4bef-a921-0aabe414d5d2.png)

# 缓存规则

```typescript
 * SSR 缓存配置和工具函数
 * 
 * 缓存验证机制（白名单模式）：
 * 1. 只缓存 HTTP 状态码 200-399 的响应
 * 2. 检查响应体大小（至少 500 字节）
 * 3. 🔥 【白名单】页面必须包含 data-cache="cache-correct-control" 标识才允许缓存
 * 4. 检查是否包含明显错误标记（CommonError404、"出错啦"等）
 * 
 * 如何使用：
 * 在页面模板中添加缓存控制标识：
 * <div data-cache="cache-correct-control">页面内容</div>
```

# Referer代理

# 租户隔离
2.1 站点
● 大集商城PC 主站 https://dev.chinamarket.cn/
● 大集商城PC 英文站 http://global-dev.chinamarket.cn/
● 大集商城PC 香港站 https://hk-dev.chinamarket.cn/
● 大集商城PC 印度尼西亚站 https://idn-dev.chinamarket.cn/
● 大集商城PC 阿联酋站 https://uae-dev.chinamarket.cn/
2.1 页面
1. 首页 /
2. 逛市场 /market
3. 国家馆 /national-pavilion
4. 外贸综合服务 /outside-trade-serve
5. 服务市场 /ai-tools /service-market
6. 店铺 /shop 
7. 外贸服务 /outside-trade-serve
8. 商品详情 /goods-detail
9. 类目页、榜单页 /mall
10. 关于我们 /about-us

页面正则匹配参考如下：
  '/',
  '/market/**',
  '/mall/**',
  '/national-pavilion/**',
  '/outside-trade-serve/**',
  '/ai-tools/**',
  '/shop/**',
  '/government-services/**',
  '/service-market/**',
  '/goods-detail/**',
  '/about-us/**',
实现路线
3.1 公共接口
存入Redis 12分区
3.2 页面
存入当前服务器硬盘中
3.2.1 刷新策略
● 首次访问：缓存文件到服务器中
● 后续访问：击中缓存，服务器不再计算
● 客户端表现：每次访问页面时自动刷新数据（在初始缓存HTML加载后获取最新数据）
3.2.2 缓存接口
● 提供缓存接口清空对应服务缓存
3.2.3 缓存策略
● 初始缓存4小时，再次请求会返回缓存内容
● 重新部署会全部清空页面缓存
● 接口错误，或数据获取失败，不会缓存页面，避免缓存污染
● 缓存页面条数2000条，可以修改
● 请求头中可以查看缓存是否击中：x-page-cache：miss | hit
